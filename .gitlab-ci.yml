stages:
  - test
  - build_test_push
  - deploy

test:
  image: python:alpine
  stage: test
  script:
    - cd app/image
    - pip install .
    - py.test

build_test_push_image:
  image: docker:dind
  stage: build_test_push
  before_script:
    - docker login --username=$DOCKER_USERNAME --password=$DOCKER_PASSWORD
  script:
    - cd app/
    - docker build -t new_app_image .
    - docker run new_app_image -e TESTING=TRUE
    - doger tag new_app_image joelfreeman/aws-ecs-app:$(CI_COMMIT_SHORT_SHA)
    - docker push joelfreeman/aws-ecs-app:$(CI_COMMIT_SHORT_SHA)

deploy-to-prod:
  image: silintl/ecs-deploy
  stage: deploy
  script:
    - ecs-deploy -k $AWS_ACCESS_KEY -s $AWS_SECRET_KEY -r ap-southeast-2 -c app-ecs-cluster -n aws-ecs-app -i joelfreeman/aws-ecs-app -e $CI_COMMIT_SHA --enable-rollback


  
    



